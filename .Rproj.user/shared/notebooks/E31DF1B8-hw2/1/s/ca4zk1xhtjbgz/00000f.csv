"0","sequential<-function(sigma,plot_graph){"
"0","#初值准备"
"0","N<-1000"
"0","weight<-rep(1/N,N)"
"0","rho<-0.9"
"0","partical<-list()"
"0","for(i in 1:N){"
"0","  new_partical<-list()"
"0","  new_partical$X0<-NA"
"0","  new_partical$Y0<-NA"
"0","  new_partical$X<-rep(NA,100)"
"0","  new_partical$Y<-rep(NA,100)"
"0","  new_partical$weight<-1/N"
"0","  partical[[i]]<-new_partical"
"0","}"
"0","result<-list(X=rep(NA,100),Y=rep(NA,100),ESS=c(N,rep(NA,100)))"
"0","#获取X0和Y0"
"0","for(i in 1:1000){"
"0","  partical[[i]]$X0<-rnorm(1,mean=0,sd=sqrt(1/(1-rho^2)))"
"0","  partical[[i]]$Y0<-rnorm(1,mean=0,sd=sigma/sqrt(1-rho^2))"
"0","}"
"0","random<-sample(1:1000,1)"
"0","result$X0<-partical[[random]]$X0"
"0","result$Y0<-partical[[random]]$Y0"
"0","#进行100次抽样"
"0","for(t in 1:100){"
"0","  #更新每个粒子的当前状态"
"0","  for(i in 1:N){"
"0","    if(t==1){"
"0","      partical[[i]]$Y[t]<-rnorm(1,mean=rho*partical[[i]]$X0,sd=sqrt(1+sigma^2))"
"0","      partical[[i]]$X[t]<-rnorm(1,mean=(rho*partical[[i]]$X0+partical[[i]]$Y[t]/sigma^2)/(2-rho^2+1/sigma^2),sd=sqrt(1/(2-rho^2+sigma^2)))"
"0","    }"
"0","    else{"
"0","      partical[[i]]$Y[t]<-rnorm(1,mean=rho*partical[[i]]$X[t-1],sd=sqrt(1+sigma^2))"
"0","      partical[[i]]$X[t]<-rnorm(1,mean=(rho*partical[[i]]$X[t-1]+partical[[i]]$Y[t]/sigma^2)/(2-rho^2+1/sigma^2),sd=sqrt(1/(2-rho^2+sigma^2)))"
"0","    }"
"0","  }"
"0","  #更新每个粒子的当前权重"
"0","  for(i in 1:N){"
"0","    if(t==1){"
"0","      partical[[i]]$weight<-partical[[i]]$weight*dnorm(partical[[i]]$Y[t],mean=rho*partical[[i]]$X0,sd=sqrt(1+sigma^2))"
"0","    }"
"0","    else{"
"0","      partical[[i]]$weight<-partical[[i]]$weight*dnorm(partical[[i]]$Y[t],mean=rho*partical[[i]]$X[t-1],sd=sqrt(1+sigma^2))"
"0","    }"
"0","  }"
"0","  #对权重进行归一化处理"
"0","  currentweight<-sapply(partical,function(x) x$weight)  "
"0","  currentweight<-currentweight/sum(currentweight) "
"0","  for(i in 1:N) {"
"0","    partical[[i]]$weight<-currentweight[i]"
"0","  }"
"0","  #如果ESS过小需要再次更新权重"
"0","  ESS<-(sum(currentweight))^2/(sum(currentweight^2))"
"0","  result$ESS[t+1]<-ESS"
"0","  if(ESS<500){"
"0","    for(i in 1:N){"
"0","      partical[[i]]$weight<-1/N"
"0","    }"
"0","  }"
"0","  #按更新后的权重抽样"
"0","  currentweight<-numeric(N)"
"0","  for(i in 1:N){"
"0","    currentweight[i]<-partical[[i]]$weight"
"0","  }"
"0","  random<-sample(1:1000,1,prob=currentweight)"
"0","  result$X[t]<-partical[[random]]$X[t]"
"0","  result$Y[t]<-partical[[random]]$Y[t]"
"0","}"
"0","if(plot_graph){"
"0","#画出频率分布直方图"
"0","X<-result$X"
"0","ESS<-result$ESS"
"0","library(ggplot2)"
"0","histogram_X<-ggplot(data=NULL, aes(x=X))+"
"0","  geom_histogram(binwidth=1,fill=""skyblue"",color=""black"",alpha=0.7)+  "
"0","  labs(title=""Histogram of X"",x=""X"",y=""Frequency"")+"
"0","  theme_minimal()"
"0","print(histogram_X)"
"0","#画出ESS随t变化的折线图"
"0","t<-seq(0,100,by=1)"
"0","ESS<-result$ESS"
"0","plot(t,ESS,type=""l"",col=""purple"")"
"0","}"
"0","return(result)"
"0","}"
"0","sequential(0.2,TRUE)"
